name: Build & Deploy Agents

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for ARM cross-build)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build amd64 image
        run: |
          docker buildx build --platform linux/amd64 -t lobstr-agent:amd64 --load ./shared
          docker save lobstr-agent:amd64 | gzip > lobstr-agent-amd64.tar.gz

      - name: Build arm64 image
        run: |
          docker buildx build --platform linux/arm64 -t lobstr-agent:arm64 --load ./shared
          docker save lobstr-agent:arm64 | gzip > lobstr-agent-arm64.tar.gz

      - name: Setup SSH keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SENTINEL_SSH_KEY }}" > ~/.ssh/sentinel_key
          echo "${{ secrets.ARBITER_SSH_KEY }}" > ~/.ssh/arbiter_key
          echo "${{ secrets.STEWARD_SSH_KEY }}" > ~/.ssh/steward_key
          chmod 600 ~/.ssh/*_key

      - name: Deploy Sentinel (ARM)
        run: |
          SCP_OPTS="-o StrictHostKeyChecking=no -i ~/.ssh/sentinel_key -P 2222"
          SSH_OPTS="-o StrictHostKeyChecking=no -i ~/.ssh/sentinel_key -p 2222"
          HOST="${{ secrets.VPS_SSH_USER }}@${{ secrets.SENTINEL_HOST }}"
          scp $SCP_OPTS lobstr-agent-arm64.tar.gz "$HOST":/tmp/lobstr-agent.tar.gz
          scp $SCP_OPTS sentinel/docker-compose.yml sentinel/SOUL.md sentinel/IDENTITY.md sentinel/HEARTBEAT.md sentinel/crontab "$HOST":/opt/lobstr/compose/
          ssh $SSH_OPTS "$HOST" bash -s <<'SENTINEL_EOF'
          docker load < /tmp/lobstr-agent.tar.gz
          rm -f /tmp/lobstr-agent.tar.gz
          docker tag lobstr-agent:arm64 lobstr-agent:latest
          cd /opt/lobstr/compose
          docker compose -p compose --env-file /opt/lobstr/compose/.env up -d
          sleep 5
          if docker ps --filter "name=lobstr-sentinel" --filter "status=running" -q | grep -q .; then
            echo "Sentinel is running"
          else
            echo "WARNING: Sentinel not running"
            docker logs lobstr-sentinel --tail 10 2>/dev/null || true
          fi
          SENTINEL_EOF

      - name: Deploy Arbiter (x86)
        run: |
          SCP_OPTS="-o StrictHostKeyChecking=no -i ~/.ssh/arbiter_key -P 2222"
          SSH_OPTS="-o StrictHostKeyChecking=no -i ~/.ssh/arbiter_key -p 2222"
          HOST="${{ secrets.VPS_SSH_USER }}@${{ secrets.ARBITER_HOST }}"
          scp $SCP_OPTS lobstr-agent-amd64.tar.gz "$HOST":/tmp/lobstr-agent.tar.gz
          scp $SCP_OPTS arbiter/docker-compose.yml arbiter/SOUL.md arbiter/IDENTITY.md arbiter/HEARTBEAT.md arbiter/crontab "$HOST":/opt/lobstr/compose/
          ssh $SSH_OPTS "$HOST" bash -s <<'ARBITER_EOF'
          docker load < /tmp/lobstr-agent.tar.gz
          rm -f /tmp/lobstr-agent.tar.gz
          docker tag lobstr-agent:amd64 lobstr-agent:latest
          cd /opt/lobstr/compose
          docker compose -p compose --env-file /opt/lobstr/compose/.env up -d
          sleep 5
          if docker ps --filter "name=lobstr-arbiter" --filter "status=running" -q | grep -q .; then
            echo "Arbiter is running"
          else
            echo "WARNING: Arbiter not running"
            docker logs lobstr-arbiter --tail 10 2>/dev/null || true
          fi
          ARBITER_EOF

      - name: Deploy Steward (x86)
        run: |
          SCP_OPTS="-o StrictHostKeyChecking=no -i ~/.ssh/steward_key -P 2222"
          SSH_OPTS="-o StrictHostKeyChecking=no -i ~/.ssh/steward_key -p 2222"
          HOST="${{ secrets.VPS_SSH_USER }}@${{ secrets.STEWARD_HOST }}"
          scp $SCP_OPTS lobstr-agent-amd64.tar.gz "$HOST":/tmp/lobstr-agent.tar.gz
          scp $SCP_OPTS steward/docker-compose.yml steward/SOUL.md steward/IDENTITY.md steward/HEARTBEAT.md steward/crontab "$HOST":/opt/lobstr/compose/
          ssh $SSH_OPTS "$HOST" bash -s <<'STEWARD_EOF'
          docker load < /tmp/lobstr-agent.tar.gz
          rm -f /tmp/lobstr-agent.tar.gz
          docker tag lobstr-agent:amd64 lobstr-agent:latest
          cd /opt/lobstr/compose
          docker compose -p compose --env-file /opt/lobstr/compose/.env up -d
          sleep 5
          if docker ps --filter "name=lobstr-steward" --filter "status=running" -q | grep -q .; then
            echo "Steward is running"
          else
            echo "WARNING: Steward not running"
            docker logs lobstr-steward --tail 10 2>/dev/null || true
          fi
          STEWARD_EOF
